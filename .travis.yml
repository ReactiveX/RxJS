language: node_js
sudo: false

addons:
  sauce_connect:
    # Update SAUCE_USERNAME / SAUCE_ACCESS_KEY in travis if necessary
    # https://docs.travis-ci.com/user/environment-variables/#Defining-Variables-in-Repository-Settings
    # TODO: reenable saucelabs once we have update browser tests
    # sauce_connect: true

cache:
  timeout: 1000
  directories:
    - $HOME/.npm

env:
  global:
    -  secure: "w5r90XyIDrXNwIkfDJWrbojht0ASyRDPkSxIQ7QDnIJWoL9z9NnpatQ7ENFJFZqWnEaLmaUR3h+hlBek+g+rwb8TE2KEbgwnSaGEtL2rZhLbqDIAx+X1OSTJ057AHYPlXrCYyoxOC9tY+mOc7pJfg7b1URPWHLCWYFRDVdKwo2/9DE9OyVitUbNg72L2SIn8fNrn6MJy8JbtLZeiuThoHuHkkrPzSFH7eihic88kR0n2o2Sy6WeZ+dZPp3OiNh1EfC976MNvnkxGNkANAALXqRQMR/nWX3HVHDvGW25EKIDNoedoJe725ZZ/Q6Raj6KcpLEbCgw3sFBAbvMXLzHK2DQ5nPXERIMqJSgh6h0H0Qw1Dgo9TZY48YSgwy8zc6qaY9n6kprADc52mz27BRzn3pUAHy0NtkxVrLzX0FLQovltjgKvuZTLdbByRTkTIMcm6qfL/QB6zUrrHqItgXwNNJB8lC4dAmY+6/iKivpN5LKSodn+Pb/JoiosSg7QeOd9qOggd4MXd5wAKUvAl5ksxLvnjKcwZyzC9uACJ7BYRwkaXwjdgpuD6CP3bcsQopNG6Z+kJTLRoSWWV4EFV52jcn52vuBqs72PnIx1tBLZFONWJhRNJR186srUfYol4joNN4ECpLXMUWBO6KvjJT8MFCk8qiKlVJ8h0ZkFle+lHV0="

  matrix:
  - NODE_VER=8 FULL_VALIDATE=true
  - NODE_VER=8 TSC_VERSION=2.8.*
  - NODE_VER=8 TSC_VERSION=next
  - NODE_VER=9
  - NODE_VER=9 TSC_VERSION=2.8.*
  - NODE_VER=9 TSC_VERSION=next
  - NODE_VER=10
  - NODE_VER=10 TSC_VERSION=2.8.*
  - NODE_VER=10 TSC_VERSION=next

matrix:
  fast_finish: true
  allow_failures:
    - NODE_VER=8 TSC_VERSION=2.8.*
    - NODE_VER=8 TSC_VERSION=next
    - NODE_VER=9 TSC_VERSION=2.8.*
    - NODE_VER=9 TSC_VERSION=next
    - NODE_VER=10 TSC_VERSION=2.8.*
    - NODE_VER=10 TSC_VERSION=next

before_install:
  - nvm install $NODE_VER
  - npm install -g npm@6 && node -v && npm -v

install:
  - npm ci
 # - if [ "$FULL_VALIDATE" == "trrunue" ]; then npm  lint && npm run dtslint && npm run test:circular; fi

script:
  - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
  - if [ "$FULL_VALIDATE" == "true" ] && [ -n "DANGER_GITHUB_API_TOKEN" ]; then echo {} > ./.babelrc && npx danger; fi
  - npm test
  - npm run test:systemjs
  - if [ "${TSC_VERSION}" ]; then npm install --no-save typescript@$TSC_VERSION && ./node_modules/.bin/tsc --version && npm run build_cjs ; fi
  - if [ "$FULL_VALIDATE" == "true" ] && [ -n "DANGER_GITHUB_API_TOKEN" ]; then cd docs_app && npm ci && npm run build && cd ..; fi

after_success:
  - if [ "$FULL_VALIDATE" == "true" ]; then npm run test:cover && npx nyc report --reporter=text-lcov | npx coveralls; fi
  - if [ "$FULL_VALIDATE" == "true" ]; then npm run tests2png && cd docs_app && chmod 755 scripts/deploy-to-firebase.sh && npm run deploy-production; fi
